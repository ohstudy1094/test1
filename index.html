const WEBHOOK_URL = 'ここにTeamsのWebhook URLを貼る';
const ZONE_KEY = 'lastNotifiedZone';

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const count = data.count;

    Logger.log("現在の人数: " + count);

    if (count < 50 || count > 260) {
      Logger.log("通知対象外");
      return ContentService.createTextOutput("OK");
    }

    // 混雑レベルを計算（1からスタート）
    const zone = Math.floor((count - 50) / 20) + 1;

    // 前回のゾーンを取得
    const props = PropertiesService.getScriptProperties();
    const lastZone = parseInt(props.getProperty(ZONE_KEY) || "-1");

    // レベルが変わったときだけ通知（上昇・下降どちらも）
    if (zone !== lastZone) {
      const message = `現在の人数は ${count} 人です。混雑レベルが ${zone} に変わりました。`;
      const payload = { text: message };
      const options = {
        method: 'post',
        contentType: 'application/json',
        payload: JSON.stringify(payload)
      };
      UrlFetchApp.fetch(WEBHOOK_URL, options);
      Logger.log("通知送信: レベル " + zone);
      props.setProperty(ZONE_KEY, String(zone));
    } else {
      Logger.log("混雑レベル変化なし");
    }

    return ContentService.createTextOutput("OK");

  } catch (err) {
    Logger.log("エラー: " + err);
    return ContentService.createTextOutput("NG");
  }
}
